<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mass Intention Tracking System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .controls-section {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
        }
        
        .control-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        
        .control-group select,
        .control-group input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .stats-bar {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
            padding: 20px;
            background: #f8f9fa;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            min-width: 150px;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #4facfe;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9em;
        }
        
        .data-section {
            padding: 30px;
        }
        
        .month-header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            text-align: center;
            font-size: 1.5em;
            font-weight: 600;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .editable {
            background: #fff;
            border: 1px solid #ddd;
            padding: 8px;
            border-radius: 3px;
            width: 100%;
        }
        
        .editable:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 5px rgba(79, 172, 254, 0.3);
        }
        
        .special-day {
            background: #fff3cd !important;
            color: #856404;
        }
        
        .personal-intention {
            background: #d1ecf1 !important;
            color: #0c5460;
        }
        
        .deceased-mass {
            background: #f8d7da !important;
            color: #721c24;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: black;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .export-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        @media (max-width: 768px) {
            .controls-grid {
                grid-template-columns: 1fr;
            }
            .stats-bar {
                flex-direction: column;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Mass Intention Tracking System</h1>
            <p>MSFS - Missionaries of St. Francis de Sales</p>
        </div>
        
        <!-- Controls Section -->
        <div class="controls-section">
            <div class="controls-grid">
                <div class="control-group">
                    <label for="yearSelect">Select Year:</label>
                    <select id="yearSelect" onchange="updateDisplay()">
                        <option value="2023">2023</option>
                        <option value="2024" selected>2024</option>
                        <option value="2025">2025</option>
                        <option value="2026">2026</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label for="monthSelect">Select Month:</label>
                    <select id="monthSelect" onchange="updateDisplay()">
                        <option value="all">All Months</option>
                        <option value="1">January</option>
                        <option value="2">February</option>
                        <option value="3">March</option>
                        <option value="4">April</option>
                        <option value="5">May</option>
                        <option value="6">June</option>
                        <option value="7">July</option>
                        <option value="8">August</option>
                        <option value="9">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label for="viewType">View Type:</label>
                    <select id="viewType" onchange="updateDisplay()">
                        <option value="daily">Daily Masses</option>
                        <option value="deceased">Deceased Confreres</option>
                        <option value="personal">Personal Intentions</option>
                        <option value="summary">Summary Report</option>
                    </select>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 15px;">
                <button class="btn btn-primary" onclick="addNewEntry()">Add New Entry</button>
                <button class="btn btn-success" onclick="uploadDatabase()">Upload Database</button>
                <button class="btn btn-warning" onclick="showExportOptions()">Export Data</button>
                <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;" onchange="handleFileUpload(event)">
            </div>
        </div>
        
        <!-- Statistics Bar -->
        <div class="stats-bar">
            <div class="stat-card">
                <div class="stat-number" id="totalMasses">0</div>
                <div class="stat-label">Total Masses</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="celebratedMasses">0</div>
                <div class="stat-label">Celebrated</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="missedMasses">0</div>
                <div class="stat-label">Missed</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="personalMasses">0</div>
                <div class="stat-label">Personal Intentions</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="deceasedMasses">0</div>
                <div class="stat-label">Deceased Confreres</div>
            </div>
        </div>
        
        <!-- Data Display Section -->
        <div class="data-section">
            <div id="dataDisplay"></div>
        </div>
    </div>
    
    <!-- Add Entry Modal -->
    <div id="addEntryModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addEntryModal')">&times;</span>
            <h2>Add New Mass Entry</h2>
            <div class="form-grid">
                <div class="control-group">
                    <label for="entryDate">Date (MM/DD/YYYY):</label>
                    <input type="date" id="entryDate" class="editable">
                </div>
                <div class="control-group">
                    <label for="entrySerial">Serial No:</label>
                    <input type="number" id="entrySerial" class="editable">
                </div>
                <div class="control-group">
                    <label for="entryReceiptDate">Date of Receipt:</label>
                    <input type="date" id="entryReceiptDate" class="editable">
                </div>
                <div class="control-group">
                    <label for="entryFrom">From Whom:</label>
                    <input type="text" id="entryFrom" class="editable" value="Provincial Superior">
                </div>
                <div class="control-group">
                    <label for="entryIntention">Intentions:</label>
                    <input type="text" id="entryIntention" class="editable" value="General Intention">
                </div>
                <div class="control-group">
                    <label for="entryRemarks">Remarks:</label>
                    <input type="text" id="entryRemarks" class="editable">
                </div>
                <div class="control-group">
                    <label for="entryType">Mass Type:</label>
                    <select id="entryType" class="editable">
                        <option value="daily">Daily Mass</option>
                        <option value="personal">Personal Intention</option>
                        <option value="deceased">Deceased Confrere</option>
                        <option value="special">Special Occasion</option>
                    </select>
                </div>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-primary" onclick="saveEntry()">Save Entry</button>
                <button class="btn" onclick="closeModal('addEntryModal')">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Export Options Modal -->
    <div id="exportModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('exportModal')">&times;</span>
            <h2>Export Options</h2>
            
            <div class="export-options">
                <div class="control-group">
                    <label for="exportYear">Year:</label>
                    <select id="exportYear">
                        <option value="all">All Years</option>
                        <option value="2023">2023</option>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                        <option value="2026">2026</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label for="exportMonth">Month:</label>
                    <select id="exportMonth">
                        <option value="all">All Months</option>
                        <option value="1">January</option>
                        <option value="2">February</option>
                        <option value="3">March</option>
                        <option value="4">April</option>
                        <option value="5">May</option>
                        <option value="6">June</option>
                        <option value="7">July</option>
                        <option value="8">August</option>
                        <option value="9">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label for="exportFormat">Format:</label>
                    <select id="exportFormat">
                        <option value="xlsx">Excel (.xlsx)</option>
                        <option value="csv">CSV (.csv)</option>
                        <option value="json">JSON (.json)</option>
                    </select>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <h3>Select Columns to Export:</h3>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px;">
                    <label><input type="checkbox" id="col_date" checked> Date</label>
                    <label><input type="checkbox" id="col_serial" checked> Serial No</label>
                    <label><input type="checkbox" id="col_receipt" checked> Date of Receipt</label>
                    <label><input type="checkbox" id="col_from" checked> From Whom</label>
                    <label><input type="checkbox" id="col_intention" checked> Intentions</label>
                    <label><input type="checkbox" id="col_remarks" checked> Remarks</label>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-success" onclick="exportData()">Export</button>
                <button class="btn" onclick="closeModal('exportModal')">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Global data storage
        let massDatabase = {
            daily: [],
            deceased: [],
            personal: []
        };
        
        // Month names
        const monthNames = [
            'January', 'February', 'March', 'April', 'May', 'June',
            'July', 'August', 'September', 'October', 'November', 'December'
        ];
        
        // Initialize the application
        function init() {
            loadFromLocalStorage();
            if (massDatabase.daily.length === 0) {
                loadSampleData();
            }
            updateDisplay();
            updateStats();
        }
        
        // Load sample data
        function loadSampleData() {
            // Sample daily masses for demonstration
            const sampleData = [];
            const startDate = new Date('2024-01-01');
            
            for (let i = 0; i < 31; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                
                const dateStr = formatDateForDisplay(currentDate.toISOString().split('T')[0]);
                
                sampleData.push({
                    date: dateStr,
                    serial: 300 - i,
                    receiptDate: '08/23/2023',
                    from: 'Provincial Superior',
                    intention: 'General Intention',
                    remarks: i === 23 ? 'SFS Feast Day Mass Celebrated' : '',
                    type: i === 23 ? 'special' : 'daily'
                });
            }
            
            massDatabase.daily = sampleData;
            
            // Sample deceased confreres
            massDatabase.deceased = [
                {
                    date: '01/13/2024',
                    receiptDate: '01/12/2024',
                    deathDate: '01/12/2024',
                    name: 'Fr. Mariadas Sesetti',
                    celebrated: '01/13/2024',
                    province: 'Vizag Province'
                },
                {
                    date: '02/15/2024',
                    receiptDate: '02/14/2024',
                    deathDate: '02/14/2024',
                    name: 'Fr. Joseph Charles Pednekar',
                    celebrated: '02/15/2024',
                    province: 'Goa Province'
                }
            ];
            
            // Sample personal intentions
            massDatabase.personal = [
                {
                    date: '01/18/2024',
                    month: 'January',
                    massNumber: 1,
                    intention: "Gladwin's Birthday Mass",
                    type: 'personal'
                },
                {
                    date: '02/16/2024',
                    month: 'February',
                    massNumber: 1,
                    intention: "Dominic's Birthday Mass",
                    type: 'personal'
                }
            ];
            
            saveToLocalStorage();
        }
        
        // Update display based on selected filters
        function updateDisplay() {
            const year = document.getElementById('yearSelect').value;
            const month = document.getElementById('monthSelect').value;
            const viewType = document.getElementById('viewType').value;
            
            switch(viewType) {
                case 'daily':
                    displayDailyMasses(year, month);
                    break;
                case 'deceased':
                    displayDeceasedMasses(year, month);
                    break;
                case 'personal':
                    displayPersonalMasses(year, month);
                    break;
                case 'summary':
                    displaySummary(year, month);
                    break;
            }
            
            updateStats();
        }
        
        // Display daily masses
        function displayDailyMasses(year, month) {
            const displayDiv = document.getElementById('dataDisplay');
            let html = '';
            
            if (month === 'all') {
                for (let m = 1; m <= 12; m++) {
                    html += generateMonthTable(year, m);
                }
            } else {
                html = generateMonthTable(year, parseInt(month));
            }
            
            displayDiv.innerHTML = html;
        }
        
        // Generate month table
        function generateMonthTable(year, monthNum) {
            const monthName = monthNames[monthNum - 1];
            const daysInMonth = new Date(year, monthNum, 0).getDate();
            
            let html = `
                <div class="month-header">${monthName.toUpperCase()} (${year})</div>
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Serial No.</th>
                            <th>Date of Receipt</th>
                            <th>From Whom</th>
                            <th>Intentions</th>
                            <th>Remarks</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${String(monthNum).padStart(2, '0')}/${String(day).padStart(2, '0')}/${year}`;
                const dayStr = `${day}/${year}`;
                const existingEntry = massDatabase.daily.find(entry => entry.date === dateStr);
                
                const serial = existingEntry ? existingEntry.serial : '';
                const receiptDate = existingEntry ? existingEntry.receiptDate : '';
                const from = existingEntry ? existingEntry.from : '';
                const intention = existingEntry ? existingEntry.intention : '';
                const remarks = existingEntry ? existingEntry.remarks : '';
                const rowClass = existingEntry && existingEntry.type === 'special' ? 'special-day' : '';
                
                html += `
                    <tr class="${rowClass}">
                        <td>${dayStr}</td>
                        <td>${serial}</td>
                        <td>${receiptDate}</td>
                        <td>${from}</td>
                        <td>${intention}</td>
                        <td>${remarks}</td>
                        <td>
                            <button class="btn btn-primary" style="padding: 5px 10px; font-size: 0.8em;" onclick="editEntry('${dateStr}')">Edit</button>
                            <button class="btn btn-warning" style="padding: 5px 10px; font-size: 0.8em;" onclick="deleteEntry('${dateStr}')">Delete</button>
                        </td>
                    </tr>
                `;
            }
            
            html += `
                    </tbody>
                </table>
            `;
            
            return html;
        }
        
        // Display deceased masses
        function displayDeceasedMasses(year, month) {
            const displayDiv = document.getElementById('dataDisplay');
            
            let filteredData = massDatabase.deceased;
            if (year !== 'all') {
                filteredData = filteredData.filter(entry => entry.date.includes(year));
            }
            if (month !== 'all') {
                const monthStr = String(month).padStart(2, '0');
                filteredData = filteredData.filter(entry => entry.date.startsWith(monthStr));
            }
            
            let html = `
                <div class="month-header">Masses for Deceased Confreres (${year})</div>
                <p><em>As per MSFS Constitution 118 and General Directory No. 98</em></p>
                <table>
                    <thead>
                        <tr>
                            <th>Date of Receipt</th>
                            <th>Date of Death</th>
                            <th>Name of Deceased</th>
                            <th>When Celebrated</th>
                            <th>Province</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            filteredData.forEach(entry => {
                html += `
                    <tr class="deceased-mass">
                        <td>${entry.receiptDate}</td>
                        <td>${entry.deathDate}</td>
                        <td>${entry.name}</td>
                        <td>${entry.celebrated}</td>
                        <td>${entry.province || ''}</td>
                        <td>
                            <button class="btn btn-primary" style="padding: 5px 10px; font-size: 0.8em;" onclick="editDeceasedEntry('${entry.date}')">Edit</button>
                            <button class="btn btn-warning" style="padding: 5px 10px; font-size: 0.8em;" onclick="deleteDeceasedEntry('${entry.date}')">Delete</button>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            displayDiv.innerHTML = html;
        }
        
        // Display personal masses
        function displayPersonalMasses(year, month) {
            const displayDiv = document.getElementById('dataDisplay');
            
            let filteredData = massDatabase.personal;
            if (year !== 'all') {
                filteredData = filteredData.filter(entry => entry.date.includes(year));
            }
            
            let html = `
                <div class="month-header">Personal Intention Masses (${year})</div>
                <p><em>Three personal intentions per month as per regulations</em></p>
                <table>
                    <thead>
                        <tr>
                            <th>Month</th>
                            <th>Date</th>
                            <th>Mass Number</th>
                            <th>Intention</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            filteredData.forEach(entry => {
                html += `
                    <tr class="personal-intention">
                        <td>${entry.month}</td>
                        <td>${entry.date}</td>
                        <td>${entry.massNumber}</td>
                        <td>${entry.intention}</td>
                        <td>
                            <button class="btn btn-primary" style="padding: 5px 10px; font-size: 0.8em;" onclick="editPersonalEntry('${entry.date}')">Edit</button>
                            <button class="btn btn-warning" style="padding: 5px 10px; font-size: 0.8em;" onclick="deletePersonalEntry('${entry.date}')">Delete</button>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            displayDiv.innerHTML = html;
        }
        
        // Display summary
        function displaySummary(year, month) {
            const displayDiv = document.getElementById('dataDisplay');
            const stats = calculateStats(year, month);
            
            let html = `
                <div class="month-header">Summary Report (${year})</div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
                    <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                        <h3 style="color: #4facfe; margin-top: 0;">Mass Statistics</h3>
                        <p><strong>Total Daily Masses:</strong> ${stats.totalDaily}</p>
                        <p><strong>Personal Intention Masses:</strong> ${stats.totalPersonal}</p>
                        <p><strong>Deceased Confreres Masses:</strong> ${stats.totalDeceased}</p>
                        <p><strong>Total Masses Celebrated:</strong> ${stats.totalAll}</p>
                    </div>
                    
                    <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                        <h3 style="color: #4facfe; margin-top: 0;">Monthly Breakdown</h3>
                        <p><strong>Average per Month:</strong> ${(stats.totalAll / 12).toFixed(1)}</p>
                        <p><strong>Most Active Month:</strong> ${stats.mostActiveMonth}</p>
                        <p><strong>Special Occasions:</strong> ${stats.specialOccasions}</p>
                    </div>
                </div>
            `;
            
            displayDiv.innerHTML = html;
        }
        
        // Calculate statistics
        function calculateStats(year, month) {
            let dailyCount = massDatabase.daily.length;
            let personalCount = massDatabase.personal.length;
            let deceasedCount = massDatabase.deceased.length;
            
            if (year !== 'all') {
                dailyCount = massDatabase.daily.filter(entry => entry.date.includes(year)).length;
                personalCount = massDatabase.personal.filter(entry => entry.date.includes(year)).length;
                deceasedCount = massDatabase.deceased.filter(entry => entry.date.includes(year)).length;
            }
            
            return {
                totalDaily: dailyCount,
                totalPersonal: personalCount,
                totalDeceased: deceasedCount,
                totalAll: dailyCount + personalCount + deceasedCount,
                mostActiveMonth: 'January',
                specialOccasions: massDatabase.daily.filter(entry => entry.type === 'special').length
            };
        }
        
        // Update statistics display
        function updateStats() {
            const year = document.getElementById('yearSelect').value;
            const stats = calculateStats(year, 'all');
            
            document.getElementById('totalMasses').textContent = stats.totalAll;
            document.getElementById('celebratedMasses').textContent = stats.totalDaily;
            document.getElementById('missedMasses').textContent = 0; // Calculate from actual data
            document.getElementById('personalMasses').textContent = stats.totalPersonal;
            document.getElementById('deceasedMasses').textContent = stats.totalDeceased;
        }
        
        // Format date for display (MM/DD/YYYY)
        function formatDateForDisplay(dateStr) {
            if (!dateStr) return '';
            // If already in MM/DD/YYYY format, return as is
            if (dateStr.includes('/')) return dateStr;
            // If in YYYY-MM-DD format, convert
            const parts = dateStr.split('-');
            if (parts.length === 3) {
                return `${parts[1]}/${parts[2]}/${parts[0]}`;
            }
            return dateStr;
        }
        
        // Convert date from display format to storage format
        function formatDateForStorage(dateStr) {
            if (!dateStr) return '';
            if (dateStr.includes('-')) return dateStr;
            const parts = dateStr.split('/');
            if (parts.length === 3) {
                return `${parts[2]}-${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}`;
            }
            return dateStr;
        }
        
        // Show modal
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }
        
        // Close modal
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // Add new entry
        function addNewEntry() {
            // Clear form
            document.getElementById('entryDate').value = '';
            document.getElementById('entrySerial').value = '';
            document.getElementById('entryReceiptDate').value = '';
            document.getElementById('entryFrom').value = 'Provincial Superior';
            document.getElementById('entryIntention').value = 'General Intention';
            document.getElementById('entryRemarks').value = '';
            document.getElementById('entryType').value = 'daily';
            
            showModal('addEntryModal');
        }
        
        // Save entry
        function saveEntry() {
            const date = document.getElementById('entryDate').value;
            const serial = document.getElementById('entrySerial').value;
            const receiptDate = document.getElementById('entryReceiptDate').value;
            const from = document.getElementById('entryFrom').value;
            const intention = document.getElementById('entryIntention').value;
            const remarks = document.getElementById('entryRemarks').value;
            const type = document.getElementById('entryType').value;
            
            if (!date) {
                alert('Please select a date');
                return;
            }
            
            const formattedDate = formatDateForDisplay(date);
            
            // Check if entry already exists
            const existingIndex = massDatabase.daily.findIndex(entry => entry.date === formattedDate);
            
            const newEntry = {
                date: formattedDate,
                serial: parseInt(serial) || 0,
                receiptDate: formatDateForDisplay(receiptDate),
                from: from,
                intention: intention,
                remarks: remarks,
                type: type
            };
            
            if (existingIndex >= 0) {
                massDatabase.daily[existingIndex] = newEntry;
            } else {
                massDatabase.daily.push(newEntry);
            }
            
            // Save to localStorage
            saveToLocalStorage();
            
            closeModal('addEntryModal');
            updateDisplay();
            
            alert('Entry saved successfully!');
        }
        
        // Edit entry
        function editEntry(dateStr) {
            const entry = massDatabase.daily.find(e => e.date === dateStr);
            if (entry) {
                document.getElementById('entryDate').value = formatDateForStorage(entry.date);
                document.getElementById('entrySerial').value = entry.serial;
                document.getElementById('entryReceiptDate').value = formatDateForStorage(entry.receiptDate);
                document.getElementById('entryFrom').value = entry.from;
                document.getElementById('entryIntention').value = entry.intention;
                document.getElementById('entryRemarks').value = entry.remarks;
                document.getElementById('entryType').value = entry.type || 'daily';
                
                showModal('addEntryModal');
            }
        }
        
        // Delete entry
        function deleteEntry(dateStr) {
            if (confirm('Are you sure you want to delete this entry?')) {
                massDatabase.daily = massDatabase.daily.filter(entry => entry.date !== dateStr);
                saveToLocalStorage();
                updateDisplay();
            }
        }
        
        // Edit deceased entry
        function editDeceasedEntry(dateStr) {
            alert('Edit deceased entry functionality - to be implemented in next update');
        }
        
        // Delete deceased entry
        function deleteDeceasedEntry(dateStr) {
            if (confirm('Are you sure you want to delete this deceased confrere entry?')) {
                massDatabase.deceased = massDatabase.deceased.filter(entry => entry.date !== dateStr);
                saveToLocalStorage();
                updateDisplay();
            }
        }
        
        // Edit personal entry
        function editPersonalEntry(dateStr) {
            alert('Edit personal entry functionality - to be implemented in next update');
        }
        
        // Delete personal entry
        function deletePersonalEntry(dateStr) {
            if (confirm('Are you sure you want to delete this personal intention entry?')) {
                massDatabase.personal = massDatabase.personal.filter(entry => entry.date !== dateStr);
                saveToLocalStorage();
                updateDisplay();
            }
        }
        
        // Save to localStorage
        function saveToLocalStorage() {
            try {
                localStorage.setItem('massIntentionData', JSON.stringify(massDatabase));
                console.log('Data saved to localStorage');
            } catch (error) {
                console.error('Error saving to localStorage:', error);
                alert('Error saving data. Please try again.');
            }
        }
        
        // Load from localStorage
        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('massIntentionData');
                if (saved) {
                    massDatabase = JSON.parse(saved);
                    console.log('Data loaded from localStorage');
                }
            } catch (error) {
                console.error('Error loading from localStorage:', error);
                // Initialize with empty data if there's an error
                massDatabase = { daily: [], deceased: [], personal: [] };
            }
        }
        
        // Upload database
        function uploadDatabase() {
            document.getElementById('fileInput').click();
        }
        
        // Handle file upload
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Process each sheet
                    const sheetNames = workbook.SheetNames;
                    let importedData = { daily: [], deceased: [], personal: [] };
                    
                    sheetNames.forEach(sheetName => {
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        
                        if (sheetName.toLowerCase().includes('deceased')) {
                            importedData.deceased = jsonData.map(row => ({
                                date: formatDateForDisplay(row['Date'] || row['When Celebrated'] || ''),
                                receiptDate: formatDateForDisplay(row['Date of Receipt'] || ''),
                                deathDate: formatDateForDisplay(row['Date of Death'] || ''),
                                name: row['Name of Deceased'] || row['NAME OF THE DECEASED'] || '',
                                celebrated: formatDateForDisplay(row['When Celebrated'] || ''),
                                province: row['Province'] || ''
                            }));
                        } else if (sheetName.toLowerCase().includes('personal')) {
                            importedData.personal = jsonData.map(row => ({
                                date: formatDateForDisplay(row['Date'] || ''),
                                month: row['Month'] || '',
                                massNumber: row['Mass Number'] || 1,
                                intention: row['Intention'] || row['Remarks'] || '',
                                type: 'personal'
                            }));
                        } else {
                            // Daily masses
                            importedData.daily = jsonData.map(row => ({
                                date: formatDateForDisplay(row['Date'] || ''),
                                serial: parseInt(row['Serial No.'] || row['Serial No'] || 0),
                                receiptDate: formatDateForDisplay(row['Date of Receipt'] || ''),
                                from: row['From Whom'] || 'Provincial Superior',
                                intention: row['Intentions'] || 'General Intention',
                                remarks: row['Remarks'] || '',
                                type: row['Type'] || 'daily'
                            }));
                        }
                    });
                    
                    // Merge with existing data
                    massDatabase.daily = [...massDatabase.daily, ...importedData.daily];
                    massDatabase.deceased = [...massDatabase.deceased, ...importedData.deceased];
                    massDatabase.personal = [...massDatabase.personal, ...importedData.personal];
                    
                    // Remove duplicates
                    massDatabase.daily = removeDuplicates(massDatabase.daily, 'date');
                    massDatabase.deceased = removeDuplicates(massDatabase.deceased, 'date');
                    massDatabase.personal = removeDuplicates(massDatabase.personal, 'date');
                    
                    saveToLocalStorage();
                    updateDisplay();
                    
                    alert('Database uploaded successfully!');
                    
                } catch (error) {
                    console.error('Error reading file:', error);
                    alert('Error reading file: ' + error.message);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // Remove duplicates from array
        function removeDuplicates(array, key) {
            return array.filter((item, index, self) =>
                index === self.findIndex(t => t[key] === item[key])
            );
        }
        
        // Show export options
        function showExportOptions() {
            const currentYear = document.getElementById('yearSelect').value;
            const currentMonth = document.getElementById('monthSelect').value;
            
            document.getElementById('exportYear').value = currentYear;
            document.getElementById('exportMonth').value = currentMonth;
            
            showModal('exportModal');
        }
        
        // Export data
        function exportData() {
            const year = document.getElementById('exportYear').value;
            const month = document.getElementById('exportMonth').value;
            const format = document.getElementById('exportFormat').value;
            
            // Get selected columns
            const selectedColumns = [];
            if (document.getElementById('col_date').checked) selectedColumns.push('date');
            if (document.getElementById('col_serial').checked) selectedColumns.push('serial');
            if (document.getElementById('col_receipt').checked) selectedColumns.push('receiptDate');
            if (document.getElementById('col_from').checked) selectedColumns.push('from');
            if (document.getElementById('col_intention').checked) selectedColumns.push('intention');
            if (document.getElementById('col_remarks').checked) selectedColumns.push('remarks');
            
            // Filter data
            let exportData = {
                daily: massDatabase.daily,
                deceased: massDatabase.deceased,
                personal: massDatabase.personal
            };
            
            if (year !== 'all') {
                exportData.daily = exportData.daily.filter(entry => entry.date.includes(year));
                exportData.deceased = exportData.deceased.filter(entry => entry.date.includes(year));
                exportData.personal = exportData.personal.filter(entry => entry.date.includes(year));
            }
            
            if (month !== 'all') {
                const monthStr = String(month).padStart(2, '0');
                exportData.daily = exportData.daily.filter(entry => entry.date.startsWith(monthStr));
                exportData.deceased = exportData.deceased.filter(entry => entry.date.startsWith(monthStr));
                exportData.personal = exportData.personal.filter(entry => entry.date.startsWith(monthStr));
            }
            
            if (format === 'xlsx') {
                exportToExcel(exportData, selectedColumns, year, month);
            } else if (format === 'csv') {
                exportToCSV(exportData, selectedColumns, year, month);
            } else if (format === 'json') {
                exportToJSON(exportData, selectedColumns, year, month);
            }
            
            closeModal('exportModal');
        }
        
        // Export to Excel
        function exportToExcel(data, columns, year, month) {
            const wb = XLSX.utils.book_new();
            
            // Daily masses sheet
            if (data.daily.length > 0) {
                const dailyData = data.daily.map(entry => {
                    const row = {};
                    if (columns.includes('date')) row['Date'] = entry.date;
                    if (columns.includes('serial')) row['Serial No.'] = entry.serial;
                    if (columns.includes('receiptDate')) row['Date of Receipt'] = entry.receiptDate;
                    if (columns.includes('from')) row['From Whom'] = entry.from;
                    if (columns.includes('intention')) row['Intentions'] = entry.intention;
                    if (columns.includes('remarks')) row['Remarks'] = entry.remarks;
                    return row;
                });
                
                const ws1 = XLSX.utils.json_to_sheet(dailyData);
                XLSX.utils.book_append_sheet(wb, ws1, "Daily Masses");
            }
            
            // Deceased confreres sheet
            if (data.deceased.length > 0) {
                const ws2 = XLSX.utils.json_to_sheet(data.deceased.map(entry => ({
                    'Date of Receipt': entry.receiptDate,
                    'Date of Death': entry.deathDate,
                    'Name of Deceased': entry.name,
                    'When Celebrated': entry.celebrated,
                    'Province': entry.province
                })));
                XLSX.utils.book_append_sheet(wb, ws2, "Deceased Confreres");
            }
            
            // Personal intentions sheet
            if (data.personal.length > 0) {
                const ws3 = XLSX.utils.json_to_sheet(data.personal.map(entry => ({
                    'Month': entry.month,
                    'Date': entry.date,
                    'Mass Number': entry.massNumber,
                    'Intention': entry.intention
                })));
                XLSX.utils.book_append_sheet(wb, ws3, "Personal Intentions");
            }
            
            const filename = `Mass_Intentions_${year}_${month === 'all' ? 'All_Months' : monthNames[month-1]}.xlsx`;
            XLSX.writeFile(wb, filename);
        }
        
        // Export to CSV
        function exportToCSV(data, columns, year, month) {
            let csvContent = '';
            
            // Headers
            const headers = [];
            if (columns.includes('date')) headers.push('Date');
            if (columns.includes('serial')) headers.push('Serial No.');
            if (columns.includes('receiptDate')) headers.push('Date of Receipt');
            if (columns.includes('from')) headers.push('From Whom');
            if (columns.includes('intention')) headers.push('Intentions');
            if (columns.includes('remarks')) headers.push('Remarks');
            
            csvContent += headers.join(',') + '\n';
            
            // Data rows
            data.daily.forEach(entry => {
                const row = [];
                if (columns.includes('date')) row.push(entry.date);
                if (columns.includes('serial')) row.push(entry.serial);
                if (columns.includes('receiptDate')) row.push(entry.receiptDate);
                if (columns.includes('from')) row.push(entry.from);
                if (columns.includes('intention')) row.push(entry.intention);
                if (columns.includes('remarks')) row.push(entry.remarks);
                csvContent += row.join(',') + '\n';
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Mass_Intentions_${year}_${month === 'all' ? 'All_Months' : monthNames[month-1]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        // Export to JSON
        function exportToJSON(data, columns, year, month) {
            const jsonData = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Mass_Intentions_${year}_${month === 'all' ? 'All_Months' : monthNames[month-1]}.json`;
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', function() {
            init();
            
            // Close modals when clicking outside
            window.onclick = function(event) {
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    if (event.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            }
        });
    </script>
</body>
</html>
